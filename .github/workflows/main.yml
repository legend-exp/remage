name: CI

on:
  push:
    branches:
      - main
      - "releases/**"
    paths-ignore:
      - "**.md"
  pull_request:
  release:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test_on_mac:
    name: Test on macOS
    runs-on: macos-15
    defaults:
      run:
        shell: bash -el {0}

    steps:
      - uses: actions/checkout@v4
        with:
          # we need a fully checked-out repo to get version from setuptools-scm.
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.pull_request && github.event.pull_request.head.sha || github.ref }}

      - uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          activate-environment: "geant4-env"
          auto-activate-base: "false"
          channels: conda-forge
          channel-priority: "strict"
          conda-remove-defaults: "true"

      - name: Install Geant4 and native dependencies
        run: |
          # native dependencies for pyg4ometry
          brew update
          brew install opencascade cgal gmp mpfr boost

          conda install conda-forge::geant4
          conda repoquery whoneeds numpy
          conda remove --force numpy # installed by default?
          echo "CMAKE_PREFIX_PATH=$CONDA_PREFIX" >> $GITHUB_ENV

      - name: Build project
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX=../local -DRMG_BUILD_EXAMPLES=1 -DBUILD_TESTING=ON -DRMG_BUILD_DOCS=OFF ..
          make
          make install

      - name: Run minimal test suite
        run: |
          cd build
          ctest --output-on-failure --label-exclude 'extra|vis'

      - name: Minimally test installed executable
        run: |
          rm -rf build
          export PATH="$PWD/local/bin:$PATH"
          export DYLD_LIBRARY_PATH="$PWD/local/lib:$DYLD_LIBRARY_PATH"
          REMAGE_ASSERT_CPP_ORIGIN="config" remage --version

# vim: expandtab tabstop=2 shiftwidth=2
